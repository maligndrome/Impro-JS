function populate_canvas(a){var b,c=b=1;null!=a.getAttribute("data-scale")&&""!=a.getAttribute("data-scale")&&(c=b=a.getAttribute("data-scale")/1),null!=a.getAttribute("data-scale-x")&&""!=a.getAttribute("data-scale-x")&&(b=a.getAttribute("data-scale-x")/1),null!=a.getAttribute("data-scale-y")&&""!=a.getAttribute("data-scale-y")&&(c=a.getAttribute("data-scale-y")/1);var d=a.getContext("2d"),e=new Image;e.crossOrigin="Anonymous",e.src=a.getAttribute("data-src");var f=a.getAttribute("data-type");e.onload=function(){a.width=e.width=e.width*b,a.height=e.height=e.height*c,a.height+=5,d.drawImage(e,0,0,a.width,a.height-5);var g=d.getImageData(0,a.height-10,a.width,a.height-5);d.putImageData(g,0,a.height-5),process(a,f)}}function process(a,b){var c=a.getContext("2d"),d=c.getImageData(0,0,a.width,a.height),e=d.data;if("sepia"==b)e=pixel_manip(e,sepia),d.data.set(e);else if("grey"==b)e=pixel_manip(e,grey),d.data.set(e);else if("blur"==b)d.data.set(convolute(e,blur,a.height,a.width));else if("custom"==b)try{var f=a.getAttribute("data-convolution-matrix");if(""==f)throw"Empty kernel";var g=new Array,h=f.split("|");if(h.length>5)throw"The kernel is too large";for(var i=0;i<h.length;i++){if(g[i]=new Array,_s=h[i].split(","),_s.length!=h.length)throw"Only square kernels are supported";for(var j=0;j<_s.length;j++){if(isNaN(_s[j]/1))throw"Only numbers allowed in kernel";g[i].push(_s[j]/1)}}d=c.getImageData(0,0,a.width,a.height),e=d.data;var k=convolute(e,g,a.height,a.width);d.data.set(k)}catch(l){console.log("ImproJS error: "+l)}else"posterize"==b?d.data.set(quantize(e,64)):"vignette"==b?d.data.set(vignette(e,a.height,a.width,.4)):"emboss"==b?(e=convolute(e,emboss,a.height,a.width),d.data.set(e)):"edge"==b?(e=convolute(e,edge,a.height,a.width),d.data.set(e)):console.log("ImproJS error: Unsupported type");a.height=a.height-5,c.putImageData(d,0,0)}function vignette(a,b,c,d){var e,f,g;e=c/2,f=b/2,g=Math.sqrt(e*e+f*f);for(var h=0,i=a.length;i>h;h+=4){var j=Math.floor(h/(4*b)),k=h/4-j*b,l=Math.pow(Math.sqrt((k-f)*(k-f)+(j-e)*(j-e))/g,.5);a[h]=a[h]*(1-d*l),a[h+1]=a[h+1]*(1-d*l),a[h+2]=a[h+2]*(1-d*l)}return a}function rgb_to_hsv(a){for(var k=0,l=a.length;l>k;k+=4){var m=rgb2hsv(a[k],a[k+1],a[k+2]);a[k]=m[0],a[k+1]=m[1],a[k+2]=m[2]}return a}function hsv_to_rgb(a){for(var b=0,c=a.length;c>b;b+=4){var d=hsv2rgb(a[b]/360,a[b+1],a[b+2]);a[b]=d[0],a[b+1]=d[1],a[b+2]=d[2]}return a}function quantize(a,b){for(var c=0,d=a.length;d>c;c+=4)a[c]=Math.floor(a[c]/b)*b,a[c+1]=Math.floor(a[c+1]/b)*b,a[c+2]=Math.floor(a[c+2]/b)*b;return a}function pixel_manip(a,c){for(var d=0,e=a.length;e>d;d+=4)r=a[d],g=a[d+1],b=a[d+2],a[d]=r*c[0][0]+g*c[0][1]+b*c[0][2],a[d+1]=r*c[1][0]+g*c[1][1]+b*c[2][2],a[d+2]=r*c[2][0]+g*c[2][1]+b*c[2][2];return a}function convolute(a,b,c,d){for(var e=new Array,f=0;f<a.length;f+=4){for(var g=new Array,h=new Array,i=new Array,j=0;j<b.length;j++){g[j]=new Array,h[j]=new Array,i[j]=new Array;for(var k=0;k<b.length;k++)g[j].push(a[4*j*d+f+4*k]),h[j].push(a[4*j*d+f+1+4*k]),i[j].push(a[4*j*d+f+2+4*k])}for(var l=sumg=sumb=0,j=0;j<b.length;j++)for(var k=0;k<b.length;k++)l+=g[j][k]*b[j][k],sumg+=h[j][k]*b[j][k],sumb+=i[j][k]*b[j][k];e.push(l),e.push(sumg),e.push(sumb),e.push(255)}return e}function apply_kernel(a,b){for(var c=new Array,d=0;3>d;d++){c[d]=new Array;for(var e=0;e<a[d].length-b.length;e++){c[d][e]=new Array;for(var f=0;f<a[d][e].length-b.length;f++){var g=0;pixels=new Array;for(var h=0;h<b.length;h++){pixels[h]=new Array;for(var i=0;i<b.length;i++)pixels[h].push(a[d][e+h][f+i])}for(var j=0;j<b.length;j++)for(var k=0;k<b[j].length;k++)g+=pixels[j][k]*b[j][k];c[d][e].push(g)}}}return c[3]=a[3],c}function rgb2hsv(a,b,c){var d,e,f,g,h,a=a/255,b=b/255,c=c/255,i=Math.max(a,b,c),j=i-Math.min(a,b,c),k=function(a){return(i-a)/6/j+.5};return 0==j?g=h=0:(h=j/i,d=k(a),e=k(b),f=k(c),a===i?g=f-e:b===i?g=1/3+d-f:c===i&&(g=2/3+e-d),0>g?g+=1:g>1&&(g-=1)),[360*g,h,i]}function hsv2rgb(a,b,c){var d,e,f,g,h,i,j,k;switch(1===arguments.length&&(b=a.s,c=a.v,a=a.h),g=Math.floor(6*a),h=6*a-g,i=c*(1-b),j=c*(1-h*b),k=c*(1-(1-h)*b),g%6){case 0:d=c,e=k,f=i;break;case 1:d=j,e=c,f=i;break;case 2:d=i,e=c,f=k;break;case 3:d=i,e=j,f=c;break;case 4:d=k,e=i,f=c;break;case 5:d=c,e=i,f=j}return[Math.round(255*d),Math.round(255*e),Math.round(255*f)]}window.onload=function(){for(a=document.getElementsByClassName("impro"),b=0;b<a.length;b++)populate_canvas(a[b])};var sepia=[[.393,.769,.189],[.349,.686,.168],[.272,.534,.131]],grey=[[.333,.333,.333],[.333,.333,.333],[.333,.333,.333]],blur=[[.0625,.125,.0625],[.125,.25,.125],[.0625,.125,.0625]],emboss=[[-.222,-.111,0],[.111,.222,.111],[0,.111,.222]],edge=[[-1,-1,-1],[-1,8,-1],[-1,-1,-1]];
